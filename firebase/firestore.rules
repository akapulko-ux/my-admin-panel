rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // === Утилиты ===
    function isSignedIn() {
      return request.auth != null;
    }

    // Проверка роли через custom claims
    function hasRoleInToken(role) {
      return isSignedIn() && request.auth.token.role == role;
    }

    // Проверка роли через Firestore
    function hasRoleInFirestore(role) {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // Комбинированная проверка роли (либо через token, либо через Firestore)
    function isAdmin() {
      return hasRoleInToken('admin') || hasRoleInFirestore('admin');
    }

    function isAgent() {
      return hasRoleInToken('agent') || hasRoleInFirestore('agent');
    }

    function isPremiumAgent() {
      return hasRoleInToken('premium agent') || hasRoleInFirestore('premium agent');
    }

    function isDeveloper() {
      return hasRoleInToken('застройщик') || hasRoleInFirestore('застройщик');
    }

    function isModerator() {
      return hasRoleInToken('moderator') || hasRoleInFirestore('moderator');
    }

    function isAnyAgent() {
      return isAgent() || isPremiumAgent();
    }

    function isPremiumDeveloper() {
      return hasRoleInToken('премиум застройщик') || hasRoleInFirestore('премиум застройщик');
    }

    function isAnyDeveloper() {
      return isDeveloper() || isPremiumDeveloper();
    }

    function canManageProperties() {
      return isAdmin() || isAnyAgent() || isAnyDeveloper() || isModerator();
    }

    // === ADMIN ИМЕЕТ ПОЛНЫЕ ПРАВА НА ВСЁ ===
    // Админ может делать любые операции с любыми данными без ограничений
    
    // === Заявки на регистрацию ===
    match /registrationRequests/{requestId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Создание доступно всем (для отправки заявок)
      allow create: if true;
      // Чтение и обновление статуса только для админов
      allow read, update: if isAdmin();
    }

    // === Заявки агентов на регистрацию в IT Agent ===
    match /agentRegistrationRequests/{requestId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Создание доступно всем (для отправки заявок от агентов)
      allow create: if true;
      // Чтение и обновление статуса только для админов
      allow read, update: if isAdmin();
    }

    // === Шахматки (специфично для админ-панели) ===
    match /chessboards/{chessboardId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Чтение разрешено всем (для публичных ссылок)
      allow read: if true;
      // Создание/изменение/удаление для админов, moderator'ов и застройщиков
      allow create, update, delete: if isAdmin() || isModerator() || isAnyDeveloper();
    }

    // === Коллекция агентов и всё внутри неё ===
    match /agents/{agentId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // админ может всё, агент (обычный, премиум) или застройщик — только свои данные  
      allow read, write: if isAdmin() || ((isAnyAgent() || isAnyDeveloper()) && request.auth.uid == agentId);

      // чаты
      match /chats/{chatId} {
        // Админ имеет полные права
        allow read, write, delete: if isAdmin();
        allow read, write: if isAdmin() || ((isAnyAgent() || isAnyDeveloper()) && request.auth.uid == agentId);

        // support внутри чатов
        match /support/{supportId} {
          // Админ имеет полные права
          allow read, write, delete: if isAdmin();
          allow read, write: if isAdmin() || ((isAnyAgent() || isAnyDeveloper()) && request.auth.uid == agentId);
        }
      }

      // избранное агента
      match /favorites/{favoriteId} {
        // Админ имеет полные права
        allow read, write, delete: if isAdmin();
        allow read, write: if isAdmin() || ((isAnyAgent() || isAnyDeveloper()) && request.auth.uid == agentId);
      }

      // подборки агента
      match /selections/{selectionId} {
        // Админ имеет полные права
        allow read, write, delete: if isAdmin();
        allow read, write: if isAdmin() || ((isAnyAgent() || isAnyDeveloper()) && request.auth.uid == agentId);
      }
    }

    // === Недвижимость ===
    match /properties/{propertyId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // публичное чтение
      allow read: if true;
      // добавление/изменение/удаление — только admin, agent (обычный или премиум) или застройщик
      allow create, update, delete: if canManageProperties();

      match /documents/{docId} {
        // Админ имеет полные права
        allow read, write, delete: if isAdmin();
        allow read: if true;
        allow create, update, delete: if canManageProperties();
      }

      // === ROI расчеты для публичных страниц ===
      match /calculations/{calculationId} {
        // Админ имеет полные права
        allow read, write, delete: if isAdmin();
        // публичное чтение для ROI страниц
        allow read: if true;
        // создание/изменение/удаление — только admin, agent (обычный или премиум) или застройщик
        allow create, update, delete: if canManageProperties();
      }
    }

    // === Комплексы ===
    match /complexes/{complexId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow read: if true;
      allow create, update, delete: if canManageProperties();
    }

    // === Профили пользователей ===
    match /users/{userId} {
      // Админ имеет полные права на все профили
      allow read, write, delete: if isAdmin();
      // админ видит/меняет любые (для админки), обычные пользователи — только свой
      allow read, update: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
      // разрешаем создание документа пользователя самому пользователю при регистрации
      allow create: if isSignedIn() && request.auth.uid == userId;
    }

    // === PDF-файлы (если хранятся в Firestore) ===
    match /pdfs/{pdfId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow read, create, update, delete: if canManageProperties();
    }

    // === PKKPR документы ===
    match /pkkpr_documents/{pkkprNumber} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // публичное чтение
      allow read: if true;
      // создание/изменение/удаление — только admin, agent (обычный или премиум) или застройщик
      allow create, update, delete: if canManageProperties();
    }

    // === Voice AI Agent ===
    match /voiceAISessions/{sessionId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow read, write: if isSignedIn() &&
        (resource.data.agentId == request.auth.uid ||
         request.data.agentId == request.auth.uid);
    }

    match /voiceAILeads/{leadId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow read, write: if isSignedIn() &&
        (resource.data.agentId == request.auth.uid ||
         request.data.agentId == request.auth.uid);
    }

    match /voiceAISettings/{userId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow read, write: if isSignedIn() &&
        request.auth.uid == userId;
    }

    // === Transcription Usage ===
    match /transcriptionUsage/{userId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // пользователи могут читать и писать только свои данные использования
      allow read, write: if isSignedIn() && request.auth.uid == userId;
      
      match /monthly/{monthKey} {
        // Админ имеет полные права
        allow read, write, delete: if isAdmin();
        // пользователи могут читать и писать только свои месячные данные
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }

    // === Developers (Застройщики) ===
    match /developers/{developerId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow read, create, update, delete: if canManageProperties();
    }

    // === Landmarks (Достопримечательности) ===  
    match /landmarks/{landmarkId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow read: if true;
      allow create, update, delete: if canManageProperties();
    }

    // === Analytics ===
    match /analytics/{documentId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow read, create, update, delete: if canManageProperties();
    }

    // === Page Visits Analytics ===
    match /pageVisits/{visitId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Создание доступно всем (для сбора аналитики)
      allow create: if true;
      // Чтение только для админов и модераторов
      allow read: if isAdmin() || isModerator();
      // Обновление и удаление только для админов
      allow update, delete: if isAdmin();
    }

    // === User Authentication Logs ===
    match /userAuthLogs/{logId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Создание доступно всем (для сбора аналитики)
      allow create: if true;
      // Чтение только для админов и модераторов
      allow read: if isAdmin() || isModerator();
      // Обновление и удаление только для админов
      allow update, delete: if isAdmin();
    }

    // === User Interactions Analytics ===
    match /userInteractions/{interactionId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Создание доступно всем (для сбора аналитики)
      allow create: if true;
      // Чтение только для админов и модераторов
      allow read: if isAdmin() || isModerator();
      // Обновление и удаление только для админов
      allow update, delete: if isAdmin();
    }

    // === Performance Analytics ===
    match /performance/{performanceId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Создание доступно всем (для сбора аналитики)
      allow create: if true;
      // Чтение только для админов и модераторов
      allow read: if isAdmin() || isModerator();
      // Обновление и удаление только для админов
      allow update, delete: if isAdmin();
    }

    // === Error Analytics ===
    match /errors/{errorId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Создание доступно всем (для сбора аналитики)
      allow create: if true;
      // Чтение только для админов и модераторов
      allow read: if isAdmin() || isModerator();
      // Обновление и удаление только для админов
      allow update, delete: if isAdmin();
    }

    // === System Settings ===
    match /settings/{settingId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // === Notifications ===
    match /notifications/{notificationId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow read, create, update, delete: if isSignedIn();
    }

    // === Logs and Audit Trail ===
    match /logs/{logId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      allow create: if isSignedIn();
      allow read: if isAdmin();
    }

    // === Client Fixations (Фиксации клиентов) ===
    match /clientFixations/{fixationId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Агенты могут читать и создавать свои фиксации
      allow read, create: if isAnyAgent() && request.auth.uid == resource.data.agentId;
      // Застройщики могут читать и обновлять фиксации своих объектов
      allow read, update: if isAnyDeveloper();
      // Агенты могут создавать новые фиксации
      allow create: if isAnyAgent() && request.auth.uid == request.data.agentId;
    }

    // === Education (Обучение) ===
    // === Education Sections (Разделы обучения) ===
    match /educationSections/{sectionId} {
      // Чтение: если пользователь залогинен и его роль содержится в массиве roles раздела
      allow read: if isSignedIn() && (resource.data.roles.hasAny([request.auth.token.role, get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role]));
      // Создание/редактирование/удаление: admin или moderator
      allow create, update, delete: if isAdmin() || isModerator();
    }

    // === Education Topics (Темы обучения) ===
    match /educationTopics/{topicId} {
      // Получаем раздел, к которому принадлежит тема
      function sectionHasAccess() {
        return exists(/databases/$(database)/documents/educationSections/$(resource.data.sectionId)) &&
          get(/databases/$(database)/documents/educationSections/$(resource.data.sectionId)).data.roles.hasAny([request.auth.token.role, get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role]);
      }
      // Чтение: если есть доступ к разделу
      allow read: if isSignedIn() && sectionHasAccess();
      // Создание/редактирование/удаление: только admin или moderator
      allow create, update, delete: if isAdmin() || isModerator();

      // === Уроки внутри темы ===
      match /lessons/{lessonId} {
        // Чтение: если есть доступ к разделу
        allow read: if isSignedIn() && sectionHasAccess();
        // Создание/редактирование/удаление: только admin или moderator
        allow create, update, delete: if isAdmin() || isModerator();
      }
    }

    // === ROI Calculations (Расчеты ROI) ===
    match /roiCalculations/{calculationId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Пользователи могут читать, создавать, обновлять и удалять только свои расчеты
      allow read, create, update, delete: if isSignedIn() && 
        (resource == null || resource.data.userId == request.auth.uid) &&
        (request.data == null || request.data.userId == request.auth.uid);
    }

    // === Push Notifications Collections ===
    
    // === Developer Notifications (История уведомлений застройщиков) ===
    match /developerNotifications/{notificationId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Премиум застройщики могут читать только свои уведомления
      allow read: if isPremiumDeveloper() && resource.data.developerId == request.auth.uid;
      // Только система может создавать записи (через Firebase Functions)
      allow create: if false;
      // Обновление и удаление запрещены
      allow update, delete: if false;
    }

    // === Audit Logs (Аудит действий) ===
    match /auditLogs/{logId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Только система может создавать записи (через Firebase Functions)
      allow create: if false;
      // Чтение и изменение запрещены для обычных пользователей
      allow read, update, delete: if false;
    }

    // === User FCM Tokens (FCM токены пользователей) ===
    match /userTokens/{userId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Пользователи могут читать и обновлять только свои токены
      allow read, write: if isSignedIn() && request.auth.uid == userId;
      // Удаление токенов разрешено только пользователю и админу
      allow delete: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
    }

    // === Client Leads (Заявки клиентов на объекты) ===
    match /clientLeads/{leadId} {
      // Админ имеет полные права
      allow read, write, delete: if isAdmin();
      // Создание доступно всем (для отправки заявок от клиентов)
      allow create: if true;
      // Чтение и обновление для админов, агентов и модераторов
      allow read, update: if isAdmin() || isAnyAgent() || isModerator();
    }

    // === Фоллбэк для любых новых коллекций ===
    match /{path=**} {
      // Админ имеет АБСОЛЮТНО ПОЛНЫЕ права на всё
      allow read, write, delete: if isAdmin();
      // чтение всем залогиненным
      allow read: if isSignedIn();
      // запись — только admin, agent (обычный или премиум) или застройщик
      allow create, update, delete: if canManageProperties();
    }
  }
}
